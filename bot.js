require('dotenv').config();
const { Telegraf, session } = require('telegraf');
const { message } = require('telegraf/filters');

const bot = new Telegraf(process.env.BOT_TOKEN);

// Usar sesi√≥n simple
bot.use(session());

// Mensaje de ayuda
bot.help(ctx => {
    const helpMessage = `
*Bot para Numerolog√≠a* ‚ú®
/start - Iniciar bot
/help - Ver ayuda
    `;
    ctx.reply(helpMessage, { parse_mode: "Markdown" });
});

// Comando /start
bot.command('start', ctx => {
    sendInitialMessage(ctx);
});

// Funci√≥n para enviar mensaje inicial
function sendInitialMessage(ctx) {
    ctx.session = {}; // resetear sesi√≥n
    const initialMessage = "Hola üëã\n*¬°Bienvenido! Soy tu experto en numerolog√≠a.*\nTe acompa√±ar√© a descubrir los secretos que los n√∫meros tienen para ti.\n ¬°Vamos a comenzar!\n\n¬øQu√© deseas calcular?\n\n1. Mi n√∫mero m√°gico (por tu fecha de nacimiento)\n2. N√∫mero m√°gico del d√≠a de hoy üìÖ\n3. Mi n√∫mero pitag√≥rico (por tu nombre)";
    ctx.reply(initialMessage, {
        reply_markup: {
            inline_keyboard: [
                [
                    { text: "üéÇ Mi n√∫mero m√°gico", callback_data: "mi_numero_magico" },
                    { text: "üìÖ N√∫mero m√°gico del d√≠a", callback_data: "numero_dia" }
                ],
                [
                    { text: "üî§ Mi n√∫mero pitag√≥rico", callback_data: "numero_pitagorico" }
                ]
            ]
        }
    });
}
// Caracter√≠sticas de cada n√∫mero seg√∫n la numerolog√≠a
const numerologyDescriptions = {
    1: "L√≠der, independiente, innovador y con gran fuerza de voluntad. Los nacidos bajo el n√∫mero 1 suelen ser pioneros y tener iniciativa.",
    2: "Cooperativo, diplom√°tico, sensible y pac√≠fico. El n√∫mero 2 destaca por su capacidad para trabajar en equipo y su empat√≠a.",
    3: "Creativo, comunicativo, optimista y sociable. El 3 es expresivo y disfruta de la vida social y art√≠stica.",
    4: "Pr√°ctico, organizado, trabajador y confiable. El n√∫mero 4 representa la estabilidad y el esfuerzo constante.",
    5: "Aventurero, vers√°til, curioso y amante de la libertad. El 5 busca cambios y nuevas experiencias.",
    6: "Responsable, protector, amoroso y orientado a la familia. El 6 se preocupa por el bienestar de los dem√°s.",
    7: "Anal√≠tico, introspectivo, espiritual y amante del conocimiento. El 7 busca la verdad y la sabidur√≠a.",
    8: "Ambicioso, eficiente, con visi√≥n de negocios y capacidad de liderazgo. El 8 est√° relacionado con el √©xito material.",
    9: "Humanitario, generoso, compasivo y altruista. El 9 se orienta al servicio y la ayuda a los dem√°s."
};

// An√°lisis del n√∫mero m√°gico del d√≠a
function getDayAnalysis(number) {
    const dayAnalyses = {
        1: "Hoy es un d√≠a ideal para iniciar proyectos, tomar decisiones y liderar. Aprovecha la energ√≠a para avanzar con determinaci√≥n.",
        2: "D√≠a para colaborar, escuchar y buscar acuerdos. La diplomacia y la paciencia ser√°n tus mejores aliados.",
        3: "La creatividad y la comunicaci√≥n fluir√°n. Expresa tus ideas y disfruta de actividades sociales.",
        4: "Enf√≥cate en la organizaci√≥n y el trabajo constante. Es un buen momento para poner orden y cumplir responsabilidades.",
        5: "D√≠a de cambios, movimiento y nuevas oportunidades. Mantente abierto a lo inesperado.",
        6: "Dedica tiempo a la familia y a cuidar de los dem√°s. La armon√≠a y el apoyo mutuo ser√°n importantes.",
        7: "Reflexiona, estudia y busca momentos de introspecci√≥n. Es un d√≠a para el crecimiento personal.",
        8: "Enf√≥cate en tus metas materiales y profesionales. La disciplina te acercar√° al √©xito.",
        9: "Jornada para ayudar, perdonar y cerrar ciclos. Practica la generosidad y el desapego."
    };
    return dayAnalyses[number] || "";
}
// Manejo de callback_query
bot.on('callback_query', async (ctx) => {
    const action = ctx.callbackQuery.data;

    if (action === "mi_numero_magico") {
        await ctx.reply("Por favor, escribe tu fecha de nacimiento en formato DD/MM/AAAA:");
        ctx.session.waitingForBirthday = true;
    } 
    else if (action === "numero_dia") {
        const today = new Date();
        const formattedDate = `${today.getDate().toString().padStart(2, '0')}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getFullYear()}`;
        const magicNumber = calculateMagicNumber(formattedDate);
        const analysis = getDayAnalysis(magicNumber);
        await ctx.reply(`El n√∫mero m√°gico del d√≠a de hoy (${formattedDate}) es: *${magicNumber}* ‚ú®\n\n${analysis}`, { parse_mode: "Markdown" });
        sendAnotherQuery(ctx);
    }
    else if (action === "numero_pitagorico") {
        await ctx.reply("Por favor, escribe tu nombre completo:");
        ctx.session.waitingForName = true;
    }
    else if (action === "consultar_otro") {
        sendInitialMessage(ctx);
    }
    else if (action === "salir") {
        await ctx.reply("Gracias por usar el bot. ¬°Hasta luego! üëã");
    }
});

// Manejo de mensajes de texto
bot.on(message('text'), async (ctx) => {
    const userMessage = ctx.message.text.trim();

    if (ctx.session && ctx.session.waitingForBirthday) {
        const dateRegex = /^([0-2][0-9]|3[0-1])\/(0[1-9]|1[0-2])\/\d{4}$/;
        if (dateRegex.test(userMessage)) {
            const magicNumber = calculateMagicNumber(userMessage);
            const zodiacSign = getZodiacSign(userMessage);
            const chineseSign = getChineseZodiac(userMessage);
            const description = numerologyDescriptions[magicNumber] || "";
           await ctx.reply(
                `üéâ Tu n√∫mero m√°gico es: *${magicNumber}*\n${description}\n\n‚ôà Tu signo del zodiaco es: *${zodiacSign}*\nüêâ Tu animal del hor√≥scopo chino es: *${chineseSign}*`,
                { parse_mode: "Markdown" }
            );
            ctx.session.waitingForBirthday = false;
            sendAnotherQuery(ctx);
        } else {
            await ctx.reply("‚ö†Ô∏è Fecha inv√°lida. Por favor, escribe la fecha en formato correcto DD/MM/AAAA (por ejemplo 23/08/1995).");
        }
    } else if (ctx.session && ctx.session.waitingForName) {
        const name = userMessage;
        const pitagoricNumber = calculatePythagoreanNumber(name);
        const reference = getPythagoreanReference(pitagoricNumber);
        await ctx.reply(`üî¢ El n√∫mero pitag√≥rico de tu nombre es: *${pitagoricNumber}*\n\n${reference}`, {
            parse_mode: "Markdown"
        });
        ctx.session.waitingForName = false;
        sendAnotherQuery(ctx);
    }
});

// Funci√≥n para preguntar si quiere consultar otro o salir
function sendAnotherQuery(ctx) {
    ctx.reply("¬øDeseas hacer otra consulta?", {
        reply_markup: {
            inline_keyboard: [
                [
                    { text: "üîÅ Consultar otro", callback_data: "consultar_otro" },
                    { text: "‚ùå Salir", callback_data: "salir" }
                ]
            ]
        }
    });
}

// Funci√≥n para calcular el n√∫mero m√°gico
function calculateMagicNumber(date) {
    const digits = date.replace(/[^0-9]/g, '');
    let sum = digits.split('').reduce((acc, digit) => acc + parseInt(digit), 0);
    while (sum >= 10) {
        sum = sum.toString().split('').reduce((acc, digit) => acc + parseInt(digit), 0);
    }
    return sum;
}

// Funci√≥n para obtener el signo del zodiaco
function getZodiacSign(date) {
    const [day, month] = date.split('/').map(Number);
    if ((month === 1 && day >= 20) || (month === 2 && day <= 18)) return "Acuario";
    if ((month === 2 && day >= 19) || (month === 3 && day <= 20)) return "Piscis";
    if ((month === 3 && day >= 21) || (month === 4 && day <= 19)) return "Aries";
    if ((month === 4 && day >= 20) || (month === 5 && day <= 20)) return "Tauro";
    if ((month === 5 && day >= 21) || (month === 6 && day <= 20)) return "G√©minis";
    if ((month === 6 && day >= 21) || (month === 7 && day <= 22)) return "C√°ncer";
    if ((month === 7 && day >= 23) || (month === 8 && day <= 22)) return "Leo";
    if ((month === 8 && day >= 23) || (month === 9 && day <= 22)) return "Virgo";
    if ((month === 9 && day >= 23) || (month === 10 && day <= 22)) return "Libra";
    if ((month === 10 && day >= 23) || (month === 11 && day <= 21)) return "Escorpio";
    if ((month === 11 && day >= 22) || (month === 12 && day <= 21)) return "Sagitario";
    if ((month === 12 && day >= 22) || (month === 1 && day <= 19)) return "Capricornio";
    return "Desconocido";
}

// Funci√≥n para obtener el animal del hor√≥scopo chino
function getChineseZodiac(date) {
    const year = parseInt(date.split('/')[2]);
    const animals = [
        "Mono", "Gallo", "Perro", "Cerdo", "Rata", "Buey",
        "Tigre", "Conejo", "Drag√≥n", "Serpiente", "Caballo", "Cabra"
    ];
    return animals[year % 12];
}

// Funci√≥n para calcular el n√∫mero pitag√≥rico de un nombre
function calculatePythagoreanNumber(name) {
    // Mapeo pitag√≥rico: A=1, B=2, ..., I=9, J=1, ..., R=9, S=1, ..., Z=8
    const map = {
        A:1, B:2, C:3, D:4, E:5, F:6, G:7, H:8, I:9,
        J:1, K:2, L:3, M:4, N:5, O:6, P:7, Q:8, R:9,
        S:1, T:2, U:3, V:4, W:5, X:6, Y:7, Z:8
    };
    const letters = name.toUpperCase().replace(/[^A-Z]/g, '').split('');
    let sum = letters.reduce((acc, letter) => acc + (map[letter] || 0), 0);
    while (sum >= 10 && sum !== 11 && sum !== 22 && sum !== 33) {
        sum = sum.toString().split('').reduce((acc, digit) => acc + parseInt(digit), 0);
    }
    return sum;
}

// Funci√≥n para obtener la referencia del n√∫mero pitag√≥rico
function getPythagoreanReference(number) {
    const references = {
        1: "El n√∫mero 1 representa liderazgo, independencia y originalidad.",
        2: "El n√∫mero 2 simboliza cooperaci√≥n, sensibilidad y diplomacia.",
        3: "El n√∫mero 3 est√° asociado a creatividad, comunicaci√≥n y optimismo.",
        4: "El n√∫mero 4 indica estabilidad, trabajo duro y organizaci√≥n.",
        5: "El n√∫mero 5 es libertad, aventura y adaptabilidad.",
        6: "El n√∫mero 6 representa responsabilidad, armon√≠a y servicio.",
        7: "El n√∫mero 7 es introspecci√≥n, an√°lisis y espiritualidad.",
        8: "El n√∫mero 8 simboliza poder, √©xito material y ambici√≥n.",
        9: "El n√∫mero 9 es generosidad, compasi√≥n y humanitarismo.",
        11: "El n√∫mero maestro 11 es intuici√≥n, inspiraci√≥n y visi√≥n.",
        22: "El n√∫mero maestro 22 es construcci√≥n, realizaci√≥n y liderazgo global.",
        33: "El n√∫mero maestro 33 es maestr√≠a, amor universal y ense√±anza."
    };
    return references[number] || "No hay referencia disponible para este n√∫mero.";
}

// Lanzar el bot
bot.launch();

// Capturar errores
process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));


